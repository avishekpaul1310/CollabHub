{% extends 'base.html' %}
{% load search_filters %}

{% block title %}Search | {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .search-wrapper {
        position: relative;
    }
    
    .search-icon {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        color: #6c757d;
    }
    
    .search-input {
        padding-left: 40px;
    }
    
    .filter-panel {
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .content-type-filter label {
        display: block;
        margin-bottom: 0.5rem;
    }
    
    .result-item {
        transition: all 0.2s ease;
    }
    
    .result-item:hover {
        background-color: #f8f9fa;
    }
    
    .result-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .keyboard-shortcut {
        display: inline-block;
        min-width: 20px;
        padding: 0 5px;
        font-size: 0.8rem;
        font-family: monospace;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 3px;
        box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        margin: 0 2px;
    }
    
    .shortcut-help {
        font-size: 0.9rem;
    }
    
    .saved-search-badge {
        cursor: pointer;
    }
    
    .recent-search-item {
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 4px;
    }
    
    .recent-search-item:hover {
        background-color: #f0f0f0;
    }
    
    .filter-tag {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 4px;
        padding: 2px 8px;
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 0.85rem;
    }
    
    .filter-tag .close {
        margin-left: 5px;
        font-size: 0.9rem;
    }
    
    /* Highlight search terms in results */
    .highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: bold;
    }
    
    /* Animation for search in progress */
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .search-in-progress {
        animation: pulse 1.5s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Sidebar with filters -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Filters</h5>
                    <button id="clear-filters" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>
                <div class="card-body">
                    <form id="search-filters-form" action="{% url 'search' %}" method="get" autocomplete="off">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Content Types</label>
                            <div class="content-type-filter">
                                {% for value, text in form.content_types.field.choices %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="content_types" 
                                           id="content_type_{{ value }}" value="{{ value }}"
                                           {% if value in form.content_types.value %}checked{% endif %}>
                                    <label class="form-check-label" for="content_type_{{ value }}">
                                        {{ text }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.type.id_for_label }}" class="form-label fw-bold">Work Item Type</label>
                            {{ form.type }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.recent.id_for_label }}" class="form-label fw-bold">Time Period</label>
                            {{ form.recent }}
                        </div>

                        <h6 class="fw-bold mt-4 mb-3">Advanced Filters</h6>
                        
                        <div class="accordion" id="filterAccordion">
                            <!-- Date filters -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="dateFilterHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#dateFilterCollapse" aria-expanded="false" 
                                            aria-controls="dateFilterCollapse">
                                        Date Range
                                    </button>
                                </h2>
                                <div id="dateFilterCollapse" class="accordion-collapse collapse" 
                                     aria-labelledby="dateFilterHeading" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-2">
                                            <label for="{{ form.date_from.id_for_label }}" class="form-label">From:</label>
                                            {{ form.date_from }}
                                        </div>
                                        <div class="mb-2">
                                            <label for="{{ form.date_to.id_for_label }}" class="form-label">To:</label>
                                            {{ form.date_to }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User filters -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="userFilterHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#userFilterCollapse" aria-expanded="false" 
                                            aria-controls="userFilterCollapse">
                                        User Filters
                                    </button>
                                </h2>
                                <div id="userFilterCollapse" class="accordion-collapse collapse" 
                                     aria-labelledby="userFilterHeading" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-2">
                                            <label for="{{ form.user.id_for_label }}" class="form-label">Created by User:</label>
                                            {{ form.user }}
                                        </div>
                                        <div class="mb-2">
                                            <label for="{{ form.owner.id_for_label }}" class="form-label">Owner:</label>
                                            {{ form.owner }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Thread filters -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="threadFilterHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#threadFilterCollapse" aria-expanded="false" 
                                            aria-controls="threadFilterCollapse">
                                        Thread Options
                                    </button>
                                </h2>
                                <div id="threadFilterCollapse" class="accordion-collapse collapse" 
                                     aria-labelledby="threadFilterHeading" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-2">
                                            <label for="{{ form.thread.id_for_label }}" class="form-label">Thread Filter:</label>
                                            {{ form.thread }}
                                        </div>
                                        <div class="mb-2">
                                            <label for="{{ form.visibility.id_for_label }}" class="form-label">Thread Visibility:</label>
                                            {{ form.visibility }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File filters -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="fileFilterHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#fileFilterCollapse" aria-expanded="false" 
                                            aria-controls="fileFilterCollapse">
                                        File Options
                                    </button>
                                </h2>
                                <div id="fileFilterCollapse" class="accordion-collapse collapse" 
                                     aria-labelledby="fileFilterHeading" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-2">
                                            <label for="{{ form.file_type.id_for_label }}" class="form-label">File Type:</label>
                                            {{ form.file_type }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Channel filters -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="channelFilterHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#channelFilterCollapse" aria-expanded="false" 
                                            aria-controls="channelFilterCollapse">
                                        Channel Options
                                    </button>
                                </h2>
                                <div id="channelFilterCollapse" class="accordion-collapse collapse" 
                                     aria-labelledby="channelFilterHeading" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-2">
                                            <label for="{{ form.channel_type.id_for_label }}" class="form-label">Channel Type:</label>
                                            {{ form.channel_type }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary" form="search-filters-form">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Saved and Recent Searches -->
            <div class="card mt-3">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="searchHistoryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="saved-tab" data-bs-toggle="tab" 
                                    data-bs-target="#saved-searches" type="button" role="tab" 
                                    aria-controls="saved-searches" aria-selected="true">
                                Saved
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="recent-tab" data-bs-toggle="tab" 
                                    data-bs-target="#recent-searches" type="button" role="tab" 
                                    aria-controls="recent-searches" aria-selected="false">
                                Recent
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content" id="searchHistoryTabContent">
                        <!-- Saved Searches Tab -->
                        <div class="tab-pane fade show active" id="saved-searches" role="tabpanel" aria-labelledby="saved-tab">
                            <div class="p-3">
                                {% if saved_searches %}
                                    <div class="list-group list-group-flush">
                                        {% for search in saved_searches %}
                                        <a href="{% url 'saved_search_detail' search.slug %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            {{ search.name }}
                                            {% if search.is_default %}
                                                <span class="badge bg-primary">Default</span>
                                            {% endif %}
                                        </a>
                                        {% endfor %}
                                    </div>
                                    <div class="d-grid mt-3">
                                        <a href="{% url 'saved_searches' %}" class="btn btn-sm btn-outline-primary">Manage Saved Searches</a>
                                    </div>
                                {% else %}
                                    <p class="text-muted small mb-3">You don't have any saved searches.</p>
                                    <div id="save-search-form" class="mb-3">
                                        <form method="post" action="{% url 'saved_searches' %}" class="d-flex">
                                            {% csrf_token %}
                                            <input type="text" name="name" class="form-control form-control-sm me-2" placeholder="Name this search" required>
                                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Recent Searches Tab -->
                        <div class="tab-pane fade" id="recent-searches" role="tabpanel" aria-labelledby="recent-tab">
                            <div class="p-3">
                                {% if recent_searches %}
                                    <div class="list-group list-group-flush">
                                        {% for search in recent_searches %}
                                        <a href="{% url 'search' %}?q={{ search.query|urlencode }}" class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <div class="text-truncate">{{ search.query }}</div>
                                                <small>{{ search.results_count }} results</small>
                                            </div>
                                            <small class="text-muted">{{ search.timestamp|timesince }} ago</small>
                                        </a>
                                        {% endfor %}
                                    </div>
                                    <div class="d-grid mt-3">
                                        <form method="post" action="{% url 'clear_search_history' %}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-secondary w-100">Clear History</button>
                                        </form>
                                    </div>
                                {% else %}
                                    <p class="text-muted small">Your recent searches will appear here.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Keyboard Shortcuts Help -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Keyboard Shortcuts</h5>
                </div>
                <div class="card-body">
                    <div class="shortcut-help">
                        <div class="mb-2"><span class="keyboard-shortcut">/</span> Focus search box</div>
                        <div class="mb-2"><span class="keyboard-shortcut">Ctrl</span> + <span class="keyboard-shortcut">Enter</span> Execute search</div>
                        <div class="mb-2"><span class="keyboard-shortcut">f</span> Toggle filters</div>
                        <div class="mb-2"><span class="keyboard-shortcut">s</span> Save current search</div>
                        <div class="mb-2"><span class="keyboard-shortcut">j</span> / <span class="keyboard-shortcut">k</span> Navigate results</div>
                        <div class="mb-2"><span class="keyboard-shortcut">Enter</span> Open selected result</div>
                        <div class="mb-2"><span class="keyboard-shortcut">?</span> Show all shortcuts</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main content - Search and Results -->
        <div class="col-md-9">
            <!-- Search Box -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="search-form" method="get" action="{% url 'search' %}">
                        <div class="search-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" name="q" id="search-input" class="form-control form-control-lg search-input" 
                                   placeholder="Search for work items, messages, files and more..." 
                                   value="{{ query }}" autocomplete="off">
                            
                            {% if query %}
                            <div class="mt-2">
                                <div id="active-filters" class="mb-2">
                                    {% for key, value in form.cleaned_data.items %}
                                        {% if value and key != 'content_types' %}
                                            <span class="filter-tag" data-filter-key="{{ key }}">
                                                <span class="filter-name">{{ key|title }}</span>: {{ value }}
                                                <a href="#" class="text-decoration-none remove-filter" data-filter-key="{{ key }}">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <button id="save-search-button" type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#saveSearchModal">
                                    <i class="fas fa-save"></i> Save this search
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Search Results -->
            <div id="search-results-container">
                {% if query or total_results > 0 %}
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Results {% if query %}for "{{ query }}"{% endif %}</h5>
                                <span class="text-muted">{{ total_results }} items found</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-sort-amount-down"></i> Sort by
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span class="visually-hidden">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" data-sort="relevance">Relevance</a></li>
                                    <li><a class="dropdown-item" href="#" data-sort="date-desc">Newest first</a></li>
                                    <li><a class="dropdown-item" href="#" data-sort="date-asc">Oldest first</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card-body p-0">
                            <!-- Tabs for filtering by content type -->
                            <div class="border-bottom">
                                <ul class="nav nav-tabs nav-fill">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#" data-filter="all">
                                            All Results
                                            <span class="badge bg-secondary">{{ total_results }}</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" data-filter="work_item">
                                            Work Items
                                            <span class="badge bg-secondary">{{ work_items_count }}</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" data-filter="message">
                                            Messages
                                            <span class="badge bg-secondary">{{ messages_count }}</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" data-filter="file">
                                            Files
                                            <span class="badge bg-secondary">{{ files_count }}</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            
                            {% include 'search/partials/search_results.html' %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-4x text-muted mb-3"></i>
                        <h2>Search for anything</h2>
                        <p class="text-muted">Enter keywords to search across work items, messages, threads, and files.</p>
                        <div class="text-start mx-auto py-3" style="max-width: 600px;">
                            <h5>Search tips:</h5>
                            <ul class="text-muted">
                                <li>Use the sidebar filters to narrow down your results</li>
                                <li>Search for specific types using the content type filters</li>
                                <li>Save searches you perform frequently</li>
                                <li>Use keyboard shortcuts for faster navigation</li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1" aria-labelledby="saveSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'saved_searches' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="saveSearchModalLabel">Save Current Search</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden inputs to store current search query and filters -->
                    <input type="hidden" name="current_query" value="{{ query }}">
                    {% for key, value in request.GET.items %}
                        {% if key != 'q' and key != 'page' %}
                            <input type="hidden" name="filter_{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                    
                    <div class="mb-3">
                        <label for="search-name" class="form-label">Search Name</label>
                        <input type="text" class="form-control" id="search-name" name="name" 
                               placeholder="Enter a name for this search" required>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="default-search" name="is_default">
                        <label class="form-check-label" for="default-search">
                            Make this my default search
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Search</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal fade" id="keyboardShortcutsModal" tabindex="-1" aria-labelledby="keyboardShortcutsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keyboardShortcutsModalLabel">Keyboard Shortcuts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Shortcut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="keyboard-shortcut">/</span></td>
                            <td>Focus the search box</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">Ctrl</span> + <span class="keyboard-shortcut">Enter</span></td>
                            <td>Execute search</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">f</span></td>
                            <td>Toggle filter panel</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">s</span></td>
                            <td>Save current search</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">j</span> / <span class="keyboard-shortcut">k</span></td>
                            <td>Navigate through search results (down/up)</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">Enter</span></td>
                            <td>Open the selected search result</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">1</span> - <span class="keyboard-shortcut">5</span></td>
                            <td>Switch between content type tabs</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">?</span></td>
                            <td>Show this keyboard shortcuts help</td>
                        </tr>
                        <tr>
                            <td><span class="keyboard-shortcut">Esc</span></td>
                            <td>Close modals, clear search</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('search-input');
    const searchForm = document.getElementById('search-form');
    const filtersForm = document.getElementById('search-filters-form');
    const activeFilters = document.getElementById('active-filters');
    const saveSearchBtn = document.getElementById('save-search-button');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const resultsContainer = document.getElementById('search-results-container');

    // Set focus to search input on page load (if not on mobile)
    if (window.innerWidth > 768) {
        searchInput.focus();
    }

    // Handle form submission
    searchForm.addEventListener('submit', function (e) {
        if (!searchInput.value.trim()) {
            e.preventDefault();
            searchInput.focus();
        }
    });

    // Apply filters when filter form is submitted - REPLACED WITH NEW HANDLER
    filtersForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get search query
        const searchQuery = document.getElementById('search-input').value.trim();
        
        // Create URL parameters object
        const params = new URLSearchParams();
        if (searchQuery) {
            params.append('q', searchQuery);
        }
        
        // Handle content type checkboxes
        const contentTypeCheckboxes = document.querySelectorAll('input[name="content_types"]:checked');
        if (contentTypeCheckboxes.length > 0) {
            contentTypeCheckboxes.forEach(checkbox => {
                params.append('content_types', checkbox.value);
            });
        }
        
        // Add all other form fields (selects, inputs, etc.)
        const formElements = this.querySelectorAll('select, input:not([type="checkbox"])');
        formElements.forEach(element => {
            if (element.name && element.value) {
                params.append(element.name, element.value);
            }
        });
        
        // Construct the URL and redirect
        window.location.href = '/search/?' + params.toString();
    });
    
    // Clear filters
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Reset filter form
            filtersForm.reset();
            
            // If there's a search query, resubmit with just the query
            if (searchInput.value.trim()) {
                window.location.href = '/search/?q=' + encodeURIComponent(searchInput.value.trim());
            } else {
                window.location.href = '/search/';
            }
        });
    }
    
    // Remove individual filters
    if (activeFilters) {
        const removeButtons = activeFilters.querySelectorAll('.remove-filter');
        removeButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const filterKey = this.dataset.filterKey;
                
                // Get current URL parameters
                const params = new URLSearchParams(window.location.search);
                
                // Remove the specific filter
                params.delete(filterKey);
                
                // Redirect with updated parameters
                window.location.href = '/search/?' + params.toString();
            });
        });
    }
    
    // Tab navigation for content type filtering
    const contentTypeTabs = document.querySelectorAll('[data-filter]');
    contentTypeTabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all tabs
            contentTypeTabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Get filter value
            const filter = this.dataset.filter;
            
            // Filter results based on content type
            const resultItems = document.querySelectorAll('.result-item');
            resultItems.forEach(item => {
                if (filter === 'all' || item.dataset.type === filter) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Don't trigger shortcuts when typing in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            // But allow Ctrl+Enter in search input to submit
            if (e.target === searchInput && e.ctrlKey && e.key === 'Enter') {
                searchForm.submit();
            }
            return;
        }
        
        // Focus search input with / key
        if (e.key === '/' && !e.ctrlKey && !e.altKey) {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Toggle filters panel with f key
        if (e.key === 'f' && !e.ctrlKey && !e.altKey) {
            e.preventDefault();
            const filterPanel = document.querySelector('.col-md-3');
            filterPanel.classList.toggle('d-none');
        }
        
        // Open save search modal with s key
        if (e.key === 's' && !e.ctrlKey && !e.altKey) {
            e.preventDefault();
            if (saveSearchBtn) {
                saveSearchBtn.click();
            }
        }
        
        // Show keyboard shortcuts help with ? key
        if (e.key === '?') {
            e.preventDefault();
            new bootstrap.Modal(document.getElementById('keyboardShortcutsModal')).show();
        }
        
        // Navigate through results with j/k keys
        if ((e.key === 'j' || e.key === 'k') && !e.ctrlKey && !e.altKey) {
            e.preventDefault();
            
            const resultItems = Array.from(document.querySelectorAll('.result-item:not([style*="display: none"])'));
            if (resultItems.length === 0) return;
            
            let selectedItem = document.querySelector('.result-item.selected');
            let selectedIndex = selectedItem ? resultItems.indexOf(selectedItem) : -1;
            
            // Remove current selection
            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            
            // Calculate new index
            if (e.key === 'j') {
                // Move down
                selectedIndex = selectedIndex < resultItems.length - 1 ? selectedIndex + 1 : 0;
            } else {
                // Move up
                selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : resultItems.length - 1;
            }
            
            // Apply new selection
            selectedItem = resultItems[selectedIndex];
            selectedItem.classList.add('selected');
            selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Open selected result with Enter
        if (e.key === 'Enter' && !e.ctrlKey && !e.altKey) {
            const selectedItem = document.querySelector('.result-item.selected');
            if (selectedItem) {
                e.preventDefault();
                const link = selectedItem.querySelector('a');
                if (link) {
                    link.click();
                }
            }
        }
        
        // Switch between content type tabs with number keys
        if (['1', '2', '3', '4', '5'].includes(e.key) && !e.ctrlKey && !e.altKey) {
            e.preventDefault();
            const tabIndex = parseInt(e.key) - 1;
            const tabs = Array.from(document.querySelectorAll('[data-filter]'));
            if (tabs.length > tabIndex) {
                tabs[tabIndex].click();
            }
        }
    });
    
    // Handle content type checkboxes
    const contentTypeCheckboxes = document.querySelectorAll('input[name="content_types"]');
    contentTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Check if any checkboxes are checked
            const anyChecked = Array.from(contentTypeCheckboxes).some(cb => cb.checked);
            
            // If none are checked, check all of them
            if (!anyChecked) {
                contentTypeCheckboxes.forEach(cb => {
                    cb.checked = true;
                });
            }
        });
    });
    
    // Result item hover effect
    const resultItems = document.querySelectorAll('.result-item');
    resultItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            document.querySelectorAll('.result-item.selected').forEach(selected => {
                selected.classList.remove('selected');
            });
            this.classList.add('selected');
        });
    });
    
    // Sort results
    const sortOptions = document.querySelectorAll('[data-sort]');
    sortOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            
            const sortBy = this.dataset.sort;
            
            // Get current URL parameters
            const params = new URLSearchParams(window.location.search);
            
            // Update sort parameter
            params.set('sort', sortBy);
            
            // Redirect with updated parameters
            window.location.href = '/search/?' + params.toString();
        });
    });
    
    // AJAX search for faster filtering
    function ajaxSearch(url) {
        // Show loading state
        if (resultsContainer) {
            resultsContainer.classList.add('search-in-progress');
        }
        
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Update results container with returned HTML
            if (data.html && resultsContainer) {
                resultsContainer.innerHTML = data.html;
                resultsContainer.classList.remove('search-in-progress');
                
                // Update counts in tabs
                updateTabCounts(data);
                
                // Re-attach event listeners to new content
                attachResultListeners();
                
                // Update URL without reloading page
                if (window.history && window.history.pushState) {
                    window.history.pushState({path: url}, '', url);
                }
                
                // Update active filters display
                updateActiveFilters();
            } else {
                console.error('No HTML content in response data');
                resultsContainer.classList.remove('search-in-progress');
                resultsContainer.innerHTML = '<div class="alert alert-warning">No results found.</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching search results:', error);
            resultsContainer.classList.remove('search-in-progress');
            resultsContainer.innerHTML = '<div class="alert alert-danger">Error loading search results. Please try again.</div>';
        });
    }
    
    function updateTabCounts(data) {
        // Update the count badges in the tabs
        const allTab = document.querySelector('[data-filter="all"] .badge');
        const workItemsTab = document.querySelector('[data-filter="work_item"] .badge');
        const messagesTab = document.querySelector('[data-filter="message"] .badge');
        const filesTab = document.querySelector('[data-filter="file"] .badge');
        
        if (allTab) allTab.textContent = data.total || 0;
        if (workItemsTab) workItemsTab.textContent = data.work_items || 0;
        if (messagesTab) messagesTab.textContent = data.messages || 0;
        if (filesTab) filesTab.textContent = data.files || 0;
    }
    
    function attachResultListeners() {
        // Re-attach event listeners to result items
        const resultItems = document.querySelectorAll('.result-item');
        resultItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                document.querySelectorAll('.result-item.selected').forEach(selected => {
                    selected.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });
    }
    
    // Helper function to update active filters display
    function updateActiveFilters() {
        const activeFilters = document.getElementById('active-filters');
        if (!activeFilters) return;
        
        // Clear existing filters
        activeFilters.innerHTML = '';
        
        // Get current URL parameters
        const params = new URLSearchParams(window.location.search);
        
        // Add filter tags for each parameter
        params.forEach((value, key) => {
            if (key !== 'q' && key !== 'page' && value) {
                const filterTag = document.createElement('span');
                filterTag.className = 'filter-tag';
                filterTag.dataset.filterKey = key;
                
                // Format the filter name
                let filterName = key.replace(/_/g, ' ');
                filterName = filterName.charAt(0).toUpperCase() + filterName.slice(1);
                
                filterTag.innerHTML = `
                    <span class="filter-name">${filterName}</span>: ${value}
                    <a href="#" class="text-decoration-none remove-filter" data-filter-key="${key}">
                        <i class="fas fa-times"></i>
                    </a>
                `;
                
                activeFilters.appendChild(filterTag);
            }
        });
        
        // Add event listeners to remove buttons
        activeFilters.querySelectorAll('.remove-filter').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const filterKey = this.dataset.filterKey;
                
                // Get current URL parameters
                const params = new URLSearchParams(window.location.search);
                
                // Remove the specific filter
                params.delete(filterKey);
                
                // Redirect with updated parameters
                window.location.href = '/search/?' + params.toString();
            });
        });
    }
    
    // Real-time filter application
    const filterInputs = filtersForm ? filtersForm.querySelectorAll('input, select') : [];
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Check if we have a search query and results already displayed
            if (searchInput.value.trim() && resultsContainer.querySelector('.result-item')) {
                // Get current search URL
                const currentUrl = new URL(window.location.href);
                const params = new URLSearchParams(currentUrl.search);
                
                // Preserve the query parameter
                if (searchInput.value.trim()) {
                    params.set('q', searchInput.value.trim());
                }
                
                // Remove any existing filter parameters
                Array.from(params.keys()).forEach(key => {
                    if (key !== 'q' && key !== 'page') {
                        params.delete(key);
                    }
                });
                
                // Update with form data
                const formData = new FormData(filtersForm);
                
                // Handle content_types checkboxes
                let hasContentType = false;
                document.querySelectorAll('input[name="content_types"]:checked').forEach(checkbox => {
                    hasContentType = true;
                    params.append('content_types', checkbox.value);
                });
                
                // Add other form fields
                for (const [key, value] of formData.entries()) {
                    if (key !== 'content_types' && value) {
                        params.set(key, value);
                    }
                }
                
                // Perform AJAX search
                const ajaxUrl = '/search/?' + params.toString();
                console.log('AJAX Search URL:', ajaxUrl); // Debug log
                ajaxSearch(ajaxUrl);
            }
        });
    });
    
    // Add CSS class to style the selected result item
    const style = document.createElement('style');
    style.textContent = `
        .result-item.selected {
            background-color: rgba(13, 110, 253, 0.1);
            border-left: 3px solid #0d6efd;
            transition: all 0.2s ease;
        }
        
        .active-filter {
            background-color: #e9f5ff;
            border-left: 3px solid #0d6efd;
        }
        
        .filter-tag {
            display: inline-block;
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 2px 8px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .filter-tag .filter-name {
            font-weight: 600;
        }
        
        .filter-tag a {
            margin-left: 5px;
            color: #6c757d;
        }
        
        .filter-tag a:hover {
            color: #dc3545;
        }
        
        .search-in-progress {
            position: relative;
        }
        
        .search-in-progress::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 1;
        }
        
        .search-in-progress::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 2;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}